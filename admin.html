<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FortuneSpin Admin</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="assets/logo.png" type="image/png" />
  <style>
    .admin-title {
      text-align: center;
      color: gold;
      font-size: 26px;
      margin: 20px 0;
    }
    .user-box {
      background: #2c2c44;
      padding: 20px;
      border-radius: 12px;
      margin: 20px auto;
      max-width: 500px;
      color: white;
    }
    .user-box input {
      margin: 6px 0;
    }
    .withdraw-box {
      background: #1e1e2f;
      padding: 15px;
      border: 1px solid #444;
      border-radius: 10px;
      margin: 15px auto;
      max-width: 450px;
    }
  </style>
</head>
<body>
  <header class="dashboard-header">

    <h1>FortuneSpin Admin</h1>
  </header>

  <main>
    <h2 class="admin-title">üë• Users</h2>
    <div id="user-list"></div>

    <h2 class="admin-title">üí∏ Withdraw Requests</h2>
    <div id="withdraw-list"></div>

    <h2 class="admin-title">üì¨ Reply to Support</h2>
    <section class="admin-section">
      <input type="text" id="reply-uid" placeholder="User UID" />
      <input type="text" id="reply-text" placeholder="Reply message" />
      <button onclick="replySupport()">Send Reply</button>
    </section>
  </main>

  <script type="module">
    import { auth, db } from './firebase.js';
    import {
      signInWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      ref, get, update, remove, onValue, set
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // Protect Admin Page
    onAuthStateChanged(auth, user => {
      if (!user || user.email !== "admin@admin.com") {
        location.href = "login.html";
      } else {
        loadUsers();
        loadWithdrawals();
      }
    });

    // üîì Load All Users
    async function loadUsers() {
      const out = document.getElementById("user-list");
      const snap = await get(ref(db, "users"));
      const users = snap.val();
      out.innerHTML = "";

      if (users) {
        Object.values(users).forEach(u => {
          out.innerHTML += `
            <div class="user-box">
              <p><b>${u.email}</b></p>
              <p>UID: ${u.uid}</p>
              <p>Balance: ‚Çπ${u.balance || 0}</p>
              <p>Referred By: ${u.referredBy || '‚Äî'}</p>
              <input type="number" placeholder="Set balance" id="bal-${u.uid}" />
              <input type="password" placeholder="New password" id="pass-${u.uid}" />
              <label><input type="checkbox" id="lock-${u.uid}" ${u.locked ? 'checked' : ''}/> Locked</label>
              <button onclick="updateUser('${u.uid}')">Update</button>
              <button onclick="deleteUser('${u.uid}')">‚ùå Delete</button>
            </div>
          `;
        });
      }
    }

    // ‚úèÔ∏è Update User
    window.updateUser = async function(uid) {
      const balInput = document.getElementById(`bal-${uid}`).value;
      const passInput = document.getElementById(`pass-${uid}`).value;
      const locked = document.getElementById(`lock-${uid}`).checked;

      const updates = {
        locked: locked
      };

      if (balInput !== "") updates.balance = parseInt(balInput);

      await update(ref(db, "users/" + uid), updates);

      // Change password if provided
      if (passInput) {
        await set(ref(db, "passwords/" + uid), passInput);
      }

      alert("User updated ‚úÖ");
      loadUsers();
    };

    // ‚ùå Delete User
    window.deleteUser = async function(uid) {
      if (!confirm("Are you sure?")) return;
      await remove(ref(db, "users/" + uid));
      await remove(ref(db, "support/" + uid));
      await remove(ref(db, "notifications/" + uid));
      alert("User deleted");
      loadUsers();
    };

    // üí∏ Load Withdrawals
    async function loadWithdrawals() {
      const out = document.getElementById("withdraw-list");
      const snap = await get(ref(db, "withdrawals"));
      const data = snap.val();
      out.innerHTML = "";

      if (data) {
        Object.entries(data).forEach(([key, obj]) => {
          if (obj.status === "pending") {
            out.innerHTML += `
              <div class="withdraw-box">
                <p><b>${obj.email}</b> requests ‚Çπ${obj.amount}</p>
                <p>UID: ${obj.uid}</p>
                <button onclick="approveWithdraw('${key}', '${obj.uid}', ${obj.amount})">‚úÖ Approve</button>
                <button onclick="rejectWithdraw('${key}')">‚ùå Reject</button>
              </div>
            `;
          }
        });
      }
    }

    // ‚úÖ Approve
    window.approveWithdraw = async function(key, uid, amount) {
      const userRef = ref(db, "users/" + uid);
      const snap = await get(userRef);
      const bal = snap.val().balance || 0;
      if (bal < amount) return alert("Insufficient balance");

      await update(ref(db, "withdrawals/" + key), { status: "approved" });
      await update(userRef, { balance: bal - amount });

      alert("Withdrawal approved");
      loadWithdrawals();
      loadUsers();
    };

    // ‚ùå Reject
    window.rejectWithdraw = async function(key) {
      await update(ref(db, "withdrawals/" + key), { status: "rejected" });
      alert("Withdrawal rejected");
      loadWithdrawals();
    };

    // üì® Reply to support
    window.replySupport = async function () {
      const uid = document.getElementById("reply-uid").value.trim();
      const msg = document.getElementById("reply-text").value.trim();
      if (!uid || !msg) return alert("Both fields required");

      const supportRef = ref(db, "support/" + uid);
      await set(ref(db, `support/${uid}/${Date.now()}`), `üë®‚Äçüíº Admin: ${msg}`);
      alert("Reply sent ‚úÖ");
    };
  </script>
</body>
</html>
