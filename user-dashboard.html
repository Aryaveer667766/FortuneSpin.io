<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fortune Realm</title>
  <link rel="stylesheet" href="style/user.css" />
  <link rel="stylesheet" href="style/spin.css" />
  <link rel="icon" href="assets/logo/logo2.png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Poppins&display=swap" rel="stylesheet">
</head>
<body>

  <!-- ğŸ”± Header -->
  <header class="dashboard-header">
    <img src="assets/logo/logo.png" />
    <h1>FortuneSpin Dashboard</h1>
    <p>Your UID: <span id="user-uid">Loading...</span></p>
  </header>

  <main>

    <!-- ğŸ”’ LOCKED SCREEN -->
    <div id="locked-msg" style="display: none;">
      <p>ğŸ”’ Your Lucky Draw is Locked</p>
      <p>Send your UID on WhatsApp to unlock spins.</p>
      <button onclick="openWhatsApp()" class="unlockBtn">ğŸ“± Contact Admin via WhatsApp</button>
    </div>

    <!-- ğŸ¡ SPIN WHEEL -->
    <section id="spin-section" style="display: none;">
      <h2>ğŸ¯ Try Your Luck!</h2>
      <img src="assets/logo/spin-wheel.png" id="wheel" />
      <br><br>
      <button onclick="spinWheel()">SPIN</button>
      <p id="spin-result">Tap SPIN to win!</p>
    </section>

    <!-- ğŸ’° BALANCE PANEL -->
    <section class="balance-section">
      <h3>ğŸ’° Your Balance</h3>
      â‚¹<span id="user-balance">0</span>
    </section>

    <!-- ğŸ§‘â€ğŸ¤â€ğŸ§‘ REFERRAL -->
    <section>
      <h3>ğŸ‘« Invite & Earn â‚¹99</h3>
      <input type="text" id="referral-link" readonly />
      <button onclick="copyReferral()">Copy Referral Link</button>
    </section>

    <!-- ğŸ†• Referral Entry -->
   

   <!-- ğŸ’¸ WITHDRAW -->
<section>
  <h3>ğŸ’¸ Withdraw Winnings</h3>

    <a href="withdraw.html">
  <button type="button">Request Withdrawal</button>
</a>
  
  <p id="withdraw-msg" style="color: gold;"></p>
</section>


    <!-- ğŸ§¾ SUPPORT TICKET -->
    <section>
      <h3>ğŸ†˜ Support Ticket</h3>
      <input type="text" id="ticket-subject" placeholder="Subject" />
      <textarea id="ticket-message" placeholder="Describe your issue..." rows="3"></textarea>
      <button onclick="submitTicket()">Submit Ticket</button>
    </section>
<!-- (If you don't already have the button, add this where you want it) -->
<div id="refill-spins-section" style="margin-top:18px;text-align:center;">
  <button id="refillSpinsBtn"
          style="padding:12px 20px;background:linear-gradient(90deg,#ffd700,#ffb400);border:none;border-radius:8px;cursor:pointer;font-weight:700;">
    ğŸ’ Refill Spins
  </button>
</div>

<!-- Self-contained script â€” paste this (below the button or at page end) -->
<script type="module">
  import { auth, db } from './js/firebase.js'; // <-- adjust path if your firebase.js is elsewhere
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import { ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('refillSpinsBtn');
    if (!btn) {
      console.error('Refill button #refillSpinsBtn not found.');
      return;
    }

    const adminPhone = '6283194274244'; // use international format WITHOUT '+' (example: 62... for Indonesia)

    // Listen for signin state
    onAuthStateChanged(auth, async (user) => {
      // If not signed in: disable & link to login
      if (!user) {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.title = 'Please login to refill spins';
        btn.addEventListener('click', () => window.location.href = 'login.html');
        return;
      }

      // If signed in: enable and attach click handler
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.title = '';

      // Try to fetch user's friendly UID (UID#XXXXXX) from DB, fallback to short form
      let displayUid = `UID#${user.uid.slice(0,6).toUpperCase()}`; // fallback

      try {
        const snap = await get(ref(db, `users/${user.uid}/uidCode`));
        if (snap && snap.exists()) {
          const val = snap.val();
          if (val) displayUid = val;
        } else {
          // fallback: maybe the UID is stored as users/{uid}.uidCode
          const userSnap = await get(ref(db, `users/${user.uid}`));
          if (userSnap && userSnap.exists()) {
            const ud = userSnap.val().uidCode;
            if (ud) displayUid = ud;
          }
        }
      } catch (err) {
        console.warn('Could not read uidCode from DB, using fallback UID.', err);
      }

      // Attach click handler (one handler only)
      btn.replaceWith(btn.cloneNode(true)); // remove previous listeners if any
      const newBtn = document.getElementById('refillSpinsBtn');

      newBtn.addEventListener('click', () => {
        const message = [
          `Hello,`,
          `I am ${displayUid}.`,
          `I want to refill `,
         
        ].join(' ');

        const waUrl = `https://wa.me/${adminPhone}?text=${encodeURIComponent(message)}`;
        // open in new tab
        window.open(waUrl, '_blank');
      });
    });
  });
</script>

    <!-- ğŸ“¢ NOTIFICATIONS -->
    <section class="notification-section">
      <h3>ğŸ“¢ Notifications</h3>
      <div id="notifications">No messages yet.</div>
    </section>

    <!-- ğŸ† WINNER FEED -->
    <section>
      <h3>ğŸ† Live Winners</h3>
      <marquee behavior="scroll" direction="left" scrollamount="5" style="color: #FFD700; font-weight:bold;" id="winner-feed">
        ğŸ‰ UID#X83KTR won â‚¹10,000 â€¢ ğŸ‰ UID#M22BDX won â‚¹5,000 â€¢ ğŸ‰ UID#A77ZZQ won â‚¹25,000ğŸ‰ UID#X83KTR won â‚¹10,000 â€¢ğŸ‰ UID#M22BDX won â‚¹5,000 â€¢ğŸ‰ UID#A77ZZQ won â‚¹25,000 â€¢ğŸ‰ UID#L94HTU won â‚¹2,000 â€¢ğŸ‰ UID#F18JOP won â‚¹15,000 â€¢ğŸ‰ UID#T73YLM won â‚¹3,000 â€¢
ğŸ‰ UID#W62QAZ won â‚¹12,000 â€¢
ğŸ‰ UID#D55VBN won â‚¹8,500 â€¢
ğŸ‰ UID#K12ZXC won â‚¹9,000 â€¢
ğŸ‰ UID#H77WER won â‚¹7,000 â€¢
ğŸ‰ UID#G99NBV won â‚¹11,000 â€¢
ğŸ‰ UID#P34MKO won â‚¹6,500 â€¢
ğŸ‰ UID#B20QWE won â‚¹13,000 â€¢
ğŸ‰ UID#R88YUI won â‚¹4,000 â€¢
ğŸ‰ UID#C41TRE won â‚¹9,800 â€¢
ğŸ‰ UID#N65BVC won â‚¹10,500 â€¢
ğŸ‰ UID#S78GHJ won â‚¹5,200 â€¢
ğŸ‰ UID#E31MNB won â‚¹6,000 â€¢
ğŸ‰ UID#U93CXZ won â‚¹18,000 â€¢
ğŸ‰ UID#V14LOP won â‚¹14,000 â€¢
ğŸ‰ UID#A09ASD won â‚¹7,700 â€¢
ğŸ‰ UID#Z56TYU won â‚¹20,000 â€¢
ğŸ‰ UID#X78JKL won â‚¹5,300 â€¢
ğŸ‰ UID#Q30MNB won â‚¹6,900 â€¢
ğŸ‰ UID#Y24WER won â‚¹22,000 â€¢
ğŸ‰ UID#J83KIO won â‚¹3,500 â€¢
ğŸ‰ UID#M77NVC won â‚¹4,800 â€¢
ğŸ‰ UID#K63RTY won â‚¹8,200 â€¢
ğŸ‰ UID#H92LPK won â‚¹11,300 â€¢
ğŸ‰ UID#B11ZXV won â‚¹19,500 â€¢
ğŸ‰ UID#O85TGB won â‚¹17,000 â€¢
ğŸ‰ UID#I32SDW won â‚¹2,800 â€¢
ğŸ‰ UID#L76BNM won â‚¹15,300 â€¢
ğŸ‰ UID#F01XCV won â‚¹13,700 â€¢
ğŸ‰ UID#T69ZSD won â‚¹16,000 â€¢
ğŸ‰ UID#W88MKO won â‚¹12,800 â€¢
ğŸ‰ UID#E25DFG won â‚¹9,900 â€¢
ğŸ‰ UID#G43RVC won â‚¹8,600 â€¢
ğŸ‰ UID#C18YUI won â‚¹4,400 â€¢
ğŸ‰ UID#P75BGT won â‚¹3,900 â€¢
ğŸ‰ UID#R99JHT won â‚¹5,600 â€¢
ğŸ‰ UID#N62XZV won â‚¹6,200 â€¢
ğŸ‰ UID#S33KLO won â‚¹7,900 â€¢
ğŸ‰ UID#U11LPD won â‚¹14,700 â€¢
ğŸ‰ UID#V52XCF won â‚¹2,600 â€¢
ğŸ‰ UID#A04RTY won â‚¹13,400 â€¢
ğŸ‰ UID#Z79OIJ won â‚¹3,100 â€¢
ğŸ‰ UID#X27GHD won â‚¹6,300 â€¢
ğŸ‰ UID#M16BNK won â‚¹5,900 â€¢
ğŸ‰ UID#T81KLO won â‚¹10,700 â€¢
ğŸ‰ UID#Y91ZXC won â‚¹11,600 â€¢
ğŸ‰ UID#K22QAZ won â‚¹18,900 â€¢
ğŸ‰ UID#J64MNB won â‚¹12,500 â€¢
ğŸ‰ UID#L13NVC won â‚¹9,600 â€¢
ğŸ‰ UID#B84WER won â‚¹17,700 â€¢
ğŸ‰ UID#F59MKO won â‚¹7,100 â€¢
ğŸ‰ UID#H46ZXV won â‚¹8,400 â€¢
ğŸ‰ UID#O97ASD won â‚¹5,100 â€¢
ğŸ‰ UID#G25XCV won â‚¹6,700 â€¢
ğŸ‰ UID#C60TYU won â‚¹4,300 â€¢
ğŸ‰ UID#P19JKL won â‚¹7,600 â€¢
ğŸ‰ UID#R33YUI won â‚¹3,300 â€¢
ğŸ‰ UID#S88TRE won â‚¹9,100 â€¢
ğŸ‰ UID#U20LOP won â‚¹10,900 â€¢
ğŸ‰ UID#V37MNB won â‚¹13,600 â€¢
ğŸ‰ UID#A61CXZ won â‚¹8,000 â€¢
ğŸ‰ UID#Z42BVC won â‚¹6,800 â€¢
ğŸ‰ UID#X06GHJ won â‚¹4,900 â€¢
ğŸ‰ UID#M51NBV won â‚¹7,200 â€¢
ğŸ‰ UID#T23OPL won â‚¹11,800 â€¢
ğŸ‰ UID#W38ERT won â‚¹15,800 â€¢
ğŸ‰ UID#E91QWE won â‚¹5,400 â€¢
ğŸ‰ UID#G09BGT won â‚¹3,800 â€¢
ğŸ‰ UID#C84MKO won â‚¹14,500 â€¢
ğŸ‰ UID#P28ZSD won â‚¹6,600 â€¢
ğŸ‰ UID#R49LPK won â‚¹9,300 â€¢
ğŸ‰ UID#N05TYU won â‚¹4,600 â€¢
ğŸ‰ UID#S11JKL won â‚¹3,600 â€¢
ğŸ‰ UID#U95YUI won â‚¹8,700 â€¢
ğŸ‰ UID#V10TRE won â‚¹11,100 â€¢
ğŸ‰ UID#A39LOP won â‚¹13,300 â€¢
ğŸ‰ UID#Z66MNB won â‚¹6,100 â€¢
ğŸ‰ UID#X70CXZ won â‚¹4,200 â€¢
ğŸ‰ UID#M36BVC won â‚¹7,500 â€¢
ğŸ‰ UID#T44GHJ won â‚¹5,800 â€¢
ğŸ‰ UID#W98NBV won â‚¹9,400 â€¢
ğŸ‰ UID#E13OPL won â‚¹12,600 â€¢
ğŸ‰ UID#G72ERT won â‚¹14,200 â€¢
ğŸ‰ UID#C03QWE won â‚¹10,300 â€¢
ğŸ‰ UID#P50BGT won â‚¹6,400 â€¢
ğŸ‰ UID#R41MKO won â‚¹8,300 â€¢
ğŸ‰ UID#N26ZSD won â‚¹5,700 â€¢
ğŸ‰ UID#S93LPK won â‚¹3,200 â€¢
ğŸ‰ UID#U07ASD won â‚¹16,500 â€¢
ğŸ‰ UID#V60XCV won â‚¹19,000 â€¢
ğŸ‰ UID#A12TYU won â‚¹20,500 â€¢
ğŸ‰ UID#Z33JKL won â‚¹9,200 â€¢
ğŸ‰ UID#X99YUI won â‚¹11,900 â€¢

      </marquee>
    </section>
  </main>

  <!-- ğŸ‰ Confetti Canvas -->
  <canvas id="confetti-canvas"></canvas>

  <!-- ğŸ”Š Sound Effects -->
  <audio id="spin-sound" src="assets/spin.mp3"></audio>
  <audio id="win-sound" src="assets/win.mp3"></audio>
  <audio id="error-sound" src="assets/sounds/error.mp3"></audio>

  <!-- âœ… Scripts -->
  <script type="module" src="js/user.js"></script>
  <script src="js/spin.js"></script>
  <canvas id="whatsappQR"></canvas>

  <script>
  function openWhatsApp() {
    const uid = document.getElementById("user-uid").textContent.trim();
    const message = `Hi, my UID is ${uid}. Please unlock my FortuneSpin account.`;
    const url = `https://wa.me/6283194274244?text=${encodeURIComponent(message)}`;
    window.open(url, "_blank");
  }

  function copyReferral() {
    const link = document.getElementById("referral-link");
    link.select();
    document.execCommand("copy");
    alert("Link copied!");
  }
</script>
</body>
</html>
