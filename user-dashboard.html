<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fortune Realm</title>
  <link rel="stylesheet" href="style/user.css" />
  <link rel="stylesheet" href="style/spin.css" />
  <link rel="icon" href="assets/logo/logo2.png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Poppins&display=swap" rel="stylesheet">
  <style>
    /* 🎡 Wheel Spin Animation */
    #wheel.spinning {
      animation: spinWheel 4s ease-out forwards;
    }

    @keyframes spinWheel {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(1440deg); } /* 4 full spins */
    }
  </style>
</head>
<body>

  <!-- 🔱 Header -->
  <header class="dashboard-header">
    <img src="assets/logo/logo.png" />
    <h1>FortuneSpin Dashboard</h1>
    <p>Your UID: <span id="user-uid">Loading...</span></p>
  </header>

  <main>

    <!-- 🔒 LOCKED SCREEN -->
    <div id="locked-msg" style="display: none;">
      <p>🔒 Your Lucky Draw is Locked</p>
      <p>Send your UID on WhatsApp to unlock spins.</p>
      <button onclick="openWhatsApp()" class="unlockBtn">📱 Unlock Your Spins NOW ! CLICK HERE !</button>
    </div>

    <!-- 🎡 SPIN WHEEL -->
    <section id="spin-section" style="display: none;">
      <h2>🎯 Try Your Luck!</h2>
      <img src="assets/logo/spin-wheel.png" id="wheel" />
      <br><br>
      <button id="spin-btn">SPIN</button>
      <p id="spin-result">Tap SPIN to win!</p>
    </section>

    <!-- 💰 BALANCE PANEL -->
    <section class="balance-section">
      <h3>💰 Your Balance</h3>
      ₹<span id="user-balance">0</span>
    </section>

    <!-- 🧑‍🤝‍🧑 REFERRAL -->
    <section>
      <h3>👫 Invite & Earn ₹99</h3>
      <input type="text" id="referral-link" readonly />
      <button onclick="copyReferral()">Copy Referral Link</button>
    </section>

    <!-- 💸 WITHDRAW -->
    <section>
      <h3>💸 Withdraw Winnings</h3>
      <a href="withdraw.html">
        <button type="button">Request Withdrawal</button>
      </a>
      <p id="withdraw-msg" style="color: gold;"></p>
    </section>

    <!-- 🧾 SUPPORT TICKET -->
    <section>
      <h3>🆘 Support Ticket</h3>
      <input type="text" id="ticket-subject" placeholder="Subject" />
      <textarea id="ticket-message" placeholder="Describe your issue..." rows="3"></textarea>
      <button onclick="submitTicket()">Submit Ticket</button>
    </section>

    <!-- Refill Spins Section -->
    <div id="refill-section" style="display:none; position: fixed; bottom: 20px; right: 20px; background: #222; color: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 9999;">
      <p style="margin: 0 0 10px;">You have 0 spins left!</p>
      <button id="refill-btn" style="padding: 10px 15px; background: green; color: white; border: none; border-radius: 5px; cursor: pointer;">Refill Spins</button>
      <button id="close-refill" style="margin-left: 10px; padding: 10px 15px; background: red; color: white; border: none; border-radius: 5px; cursor: pointer;">I will refill later</button>
    </div>

    <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    import { app } from './firebase.js';

    const auth = getAuth(app);
    const db = getDatabase(app);

    let refillDismissed = false;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const uid = user.uid;
        document.getElementById("user-uid").textContent = uid;

        const userRef = ref(db, `users/${uid}`);
        onValue(userRef, (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            const spins = data.spins || 0;
            const isLocked = data.locked || false;

            if (!isLocked && spins === 0 && !refillDismissed) {
              document.getElementById("refill-section").style.display = "block";
            } else {
              document.getElementById("refill-section").style.display = "none";
            }

            document.getElementById("refill-btn").onclick = () => {
              const whatsappNumber = "6283194274244";
              const message = `Hello, I want to refill my account. My unique id is ${uid}`;
              window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`, "_blank");
            };

            document.getElementById("close-refill").onclick = () => {
              document.getElementById("refill-section").style.display = "none";
              refillDismissed = true;
            };
          }
        });
      }
    });

    // 🎡 Spin Wheel Logic
    const spinBtn = document.getElementById("spin-btn");
    const wheel = document.getElementById("wheel");
    const spinResult = document.getElementById("spin-result");
    const spinSound = document.getElementById("spin-sound");
    const winSound = document.getElementById("win-sound");

    spinBtn.addEventListener("click", () => {
      if (wheel.classList.contains("spinning")) return;

      wheel.classList.add("spinning");
      spinSound.play();

      setTimeout(() => {
        wheel.classList.remove("spinning");
        winSound.play();
        spinResult.textContent = "🎉 You won ₹" + (Math.floor(Math.random() * 100) + 1);
      }, 4000);
    });
    </script>

    <!-- 📢 NOTIFICATIONS -->
    <section class="notification-section">
      <h3>📢 Notifications</h3>
      <div id="notifications">No messages yet.</div>
    </section>

    <!-- 🏆 WINNER FEED -->
    <section>
      <h3>🏆 Live Winners</h3>
      <marquee behavior="scroll" direction="left" scrollamount="5" style="color: #FFD700; font-weight:bold;" id="winner-feed">
        🎉 X83KTR won ₹10,000 • 🎉 M22BDX won ₹5,000 • 🎉 A77ZZQ won ₹25,000 • 🎉 L94HTU won ₹2,000 • 🎉 F18JOP won ₹15,000 • 🎉 T73YLM won ₹3,000 •
        🎉 W62QAZ won ₹12,000 • 🎉 D55VBN won ₹8,500 • 🎉 K12ZXC won ₹9,000 • 🎉 H77WER won ₹7,000 • 🎉 G99NBV won ₹11,000 • 🎉 P34MKO won ₹6,500 •
      </marquee>
    </section>
  </main>

  <canvas id="confetti-canvas"></canvas>

  <audio id="spin-sound" src="assets/spin.mp3"></audio>
  <audio id="win-sound" src="assets/win.mp3"></audio>
  <audio id="error-sound" src="assets/sounds/error.mp3"></audio>

  <script src="js/spin.js"></script>
  <canvas id="whatsappQR"></canvas>

  <script>
  function openWhatsApp() {
    let uid = document.getElementById("user-uid").textContent.trim();
    if (uid.startsWith("UID#")) {
      uid = uid.slice(4);
    }
    const message = `Hi, my UID is ${uid}. Please unlock my FortuneSpin account.`;
    const url = `https://wa.me/6283194274244?text=${encodeURIComponent(message)}`;
    window.open(url, "_blank");
  }

  function copyReferral() {
    const link = document.getElementById("referral-link");
    if (navigator.clipboard) {
      navigator.clipboard.writeText(link.value).then(() => {
        alert("Referral link copied!");
      }).catch(() => {
        fallbackCopyText(link);
      });
    } else {
      fallbackCopyText(link);
    }
  }

  function fallbackCopyText(element) {
    element.select();
    try {
      document.execCommand("copy");
      alert("Referral link copied!");
    } catch (err) {
      alert("Failed to copy. Please copy manually.");
    }
  }
  </script>

</body>
</html>
