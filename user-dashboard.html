<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fortune Realm</title>
  <link rel="stylesheet" href="style/user.css" />
  <link rel="stylesheet" href="style/spin.css" />
  <link rel="icon" href="assets/logo/logo2.png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Poppins&display=swap" rel="stylesheet">
</head>
<body>

  <!-- 🔱 Header -->
  <header class="dashboard-header">
    <img src="assets/logo/logo.png" />
    <h1>FortuneSpin Dashboard</h1>
    <p>Your UID: <span id="user-uid">Loading...</span></p>
  </header>

  <main>

    <!-- 🔒 LOCKED SCREEN -->
    <div id="locked-msg" style="display: none;">
      <p>🔒 Your Lucky Draw is Locked</p>
      <p>Send your UID on WhatsApp to unlock spins.</p>
      <button onclick="openWhatsApp()" class="unlockBtn">📱 Contact Admin via WhatsApp</button>
    </div>

    <!-- 🎡 SPIN WHEEL -->
    <section id="spin-section" style="display: none;">
      <h2>🎯 Try Your Luck!</h2>
      <img src="assets/logo/spin-wheel.png" id="wheel" />
      <br><br>
      <button onclick="spinWheel()">SPIN</button>
      <p id="spin-result">Tap SPIN to win!</p>
    </section>

    <!-- 💰 BALANCE PANEL -->
    <section class="balance-section">
      <h3>💰 Your Balance</h3>
      ₹<span id="user-balance">0</span>
    </section>

    <!-- 🧑‍🤝‍🧑 REFERRAL -->
    <section>
      <h3>👫 Invite & Earn ₹99</h3>
      <input type="text" id="referral-link" readonly />
      <button onclick="copyReferral()">Copy Referral Link</button>
    </section>

    <!-- 🆕 Referral Entry -->
   

   <!-- 💸 WITHDRAW -->
<section>
  <h3>💸 Withdraw Winnings</h3>

    <a href="withdraw.html">
  <button type="button">Request Withdrawal</button>
</a>
  
  <p id="withdraw-msg" style="color: gold;"></p>
</section>


    <!-- 🧾 SUPPORT TICKET -->
    <section>
      <h3>🆘 Support Ticket</h3>
      <input type="text" id="ticket-subject" placeholder="Subject" />
      <textarea id="ticket-message" placeholder="Describe your issue..." rows="3"></textarea>
      <button onclick="submitTicket()">Submit Ticket</button>
    </section>
<!-- (If you don't already have the button, add this where you want it) -->
<div id="refill-spins-section" style="margin-top:18px;text-align:center;">
  <button id="refillSpinsBtn"
          style="padding:12px 20px;background:linear-gradient(90deg,#ffd700,#ffb400);border:none;border-radius:8px;cursor:pointer;font-weight:700;">
    💎 Refill Spins
  </button>
</div>

<!-- Self-contained script — paste this (below the button or at page end) -->
<script type="module">
  import { auth, db } from './js/firebase.js'; // <-- adjust path if your firebase.js is elsewhere
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import { ref, get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('refillSpinsBtn');
    if (!btn) {
      console.error('Refill button #refillSpinsBtn not found.');
      return;
    }

    const adminPhone = '6283194274244'; // use international format WITHOUT '+' (example: 62... for Indonesia)

    // Listen for signin state
    onAuthStateChanged(auth, async (user) => {
      // If not signed in: disable & link to login
      if (!user) {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.title = 'Please login to refill spins';
        btn.addEventListener('click', () => window.location.href = 'login.html');
        return;
      }

      // If signed in: enable and attach click handler
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.title = '';

      // Try to fetch user's friendly UID (UID#XXXXXX) from DB, fallback to short form
      let displayUid = `UID#${user.uid.slice(0,6).toUpperCase()}`; // fallback

      try {
        const snap = await get(ref(db, `users/${user.uid}/uidCode`));
        if (snap && snap.exists()) {
          const val = snap.val();
          if (val) displayUid = val;
        } else {
          // fallback: maybe the UID is stored as users/{uid}.uidCode
          const userSnap = await get(ref(db, `users/${user.uid}`));
          if (userSnap && userSnap.exists()) {
            const ud = userSnap.val().uidCode;
            if (ud) displayUid = ud;
          }
        }
      } catch (err) {
        console.warn('Could not read uidCode from DB, using fallback UID.', err);
      }

      // Attach click handler (one handler only)
      btn.replaceWith(btn.cloneNode(true)); // remove previous listeners if any
      const newBtn = document.getElementById('refillSpinsBtn');

      newBtn.addEventListener('click', () => {
        const message = [
          `Hello,`,
          `I am ${displayUid}.`,
          `I want to refill `,
         
        ].join(' ');

        const waUrl = `https://wa.me/${adminPhone}?text=${encodeURIComponent(message)}`;
        // open in new tab
        window.open(waUrl, '_blank');
      });
    });
  });
</script>

    <!-- 📢 NOTIFICATIONS -->
    <section class="notification-section">
      <h3>📢 Notifications</h3>
      <div id="notifications">No messages yet.</div>
    </section>

    <!-- 🏆 WINNER FEED -->
    <section>
      <h3>🏆 Live Winners</h3>
      <marquee behavior="scroll" direction="left" scrollamount="5" style="color: #FFD700; font-weight:bold;" id="winner-feed">
        🎉 UID#X83KTR won ₹10,000 • 🎉 UID#M22BDX won ₹5,000 • 🎉 UID#A77ZZQ won ₹25,000🎉 UID#X83KTR won ₹10,000 •🎉 UID#M22BDX won ₹5,000 •🎉 UID#A77ZZQ won ₹25,000 •🎉 UID#L94HTU won ₹2,000 •🎉 UID#F18JOP won ₹15,000 •🎉 UID#T73YLM won ₹3,000 •
🎉 UID#W62QAZ won ₹12,000 •
🎉 UID#D55VBN won ₹8,500 •
🎉 UID#K12ZXC won ₹9,000 •
🎉 UID#H77WER won ₹7,000 •
🎉 UID#G99NBV won ₹11,000 •
🎉 UID#P34MKO won ₹6,500 •
🎉 UID#B20QWE won ₹13,000 •
🎉 UID#R88YUI won ₹4,000 •
🎉 UID#C41TRE won ₹9,800 •
🎉 UID#N65BVC won ₹10,500 •
🎉 UID#S78GHJ won ₹5,200 •
🎉 UID#E31MNB won ₹6,000 •
🎉 UID#U93CXZ won ₹18,000 •
🎉 UID#V14LOP won ₹14,000 •
🎉 UID#A09ASD won ₹7,700 •
🎉 UID#Z56TYU won ₹20,000 •
🎉 UID#X78JKL won ₹5,300 •
🎉 UID#Q30MNB won ₹6,900 •
🎉 UID#Y24WER won ₹22,000 •
🎉 UID#J83KIO won ₹3,500 •
🎉 UID#M77NVC won ₹4,800 •
🎉 UID#K63RTY won ₹8,200 •
🎉 UID#H92LPK won ₹11,300 •
🎉 UID#B11ZXV won ₹19,500 •
🎉 UID#O85TGB won ₹17,000 •
🎉 UID#I32SDW won ₹2,800 •
🎉 UID#L76BNM won ₹15,300 •
🎉 UID#F01XCV won ₹13,700 •
🎉 UID#T69ZSD won ₹16,000 •
🎉 UID#W88MKO won ₹12,800 •
🎉 UID#E25DFG won ₹9,900 •
🎉 UID#G43RVC won ₹8,600 •
🎉 UID#C18YUI won ₹4,400 •
🎉 UID#P75BGT won ₹3,900 •
🎉 UID#R99JHT won ₹5,600 •
🎉 UID#N62XZV won ₹6,200 •
🎉 UID#S33KLO won ₹7,900 •
🎉 UID#U11LPD won ₹14,700 •
🎉 UID#V52XCF won ₹2,600 •
🎉 UID#A04RTY won ₹13,400 •
🎉 UID#Z79OIJ won ₹3,100 •
🎉 UID#X27GHD won ₹6,300 •
🎉 UID#M16BNK won ₹5,900 •
🎉 UID#T81KLO won ₹10,700 •
🎉 UID#Y91ZXC won ₹11,600 •
🎉 UID#K22QAZ won ₹18,900 •
🎉 UID#J64MNB won ₹12,500 •
🎉 UID#L13NVC won ₹9,600 •
🎉 UID#B84WER won ₹17,700 •
🎉 UID#F59MKO won ₹7,100 •
🎉 UID#H46ZXV won ₹8,400 •
🎉 UID#O97ASD won ₹5,100 •
🎉 UID#G25XCV won ₹6,700 •
🎉 UID#C60TYU won ₹4,300 •
🎉 UID#P19JKL won ₹7,600 •
🎉 UID#R33YUI won ₹3,300 •
🎉 UID#S88TRE won ₹9,100 •
🎉 UID#U20LOP won ₹10,900 •
🎉 UID#V37MNB won ₹13,600 •
🎉 UID#A61CXZ won ₹8,000 •
🎉 UID#Z42BVC won ₹6,800 •
🎉 UID#X06GHJ won ₹4,900 •
🎉 UID#M51NBV won ₹7,200 •
🎉 UID#T23OPL won ₹11,800 •
🎉 UID#W38ERT won ₹15,800 •
🎉 UID#E91QWE won ₹5,400 •
🎉 UID#G09BGT won ₹3,800 •
🎉 UID#C84MKO won ₹14,500 •
🎉 UID#P28ZSD won ₹6,600 •
🎉 UID#R49LPK won ₹9,300 •
🎉 UID#N05TYU won ₹4,600 •
🎉 UID#S11JKL won ₹3,600 •
🎉 UID#U95YUI won ₹8,700 •
🎉 UID#V10TRE won ₹11,100 •
🎉 UID#A39LOP won ₹13,300 •
🎉 UID#Z66MNB won ₹6,100 •
🎉 UID#X70CXZ won ₹4,200 •
🎉 UID#M36BVC won ₹7,500 •
🎉 UID#T44GHJ won ₹5,800 •
🎉 UID#W98NBV won ₹9,400 •
🎉 UID#E13OPL won ₹12,600 •
🎉 UID#G72ERT won ₹14,200 •
🎉 UID#C03QWE won ₹10,300 •
🎉 UID#P50BGT won ₹6,400 •
🎉 UID#R41MKO won ₹8,300 •
🎉 UID#N26ZSD won ₹5,700 •
🎉 UID#S93LPK won ₹3,200 •
🎉 UID#U07ASD won ₹16,500 •
🎉 UID#V60XCV won ₹19,000 •
🎉 UID#A12TYU won ₹20,500 •
🎉 UID#Z33JKL won ₹9,200 •
🎉 UID#X99YUI won ₹11,900 •

      </marquee>
    </section>
  </main>

  <!-- 🎉 Confetti Canvas -->
  <canvas id="confetti-canvas"></canvas>

  <!-- 🔊 Sound Effects -->
  <audio id="spin-sound" src="assets/spin.mp3"></audio>
  <audio id="win-sound" src="assets/win.mp3"></audio>
  <audio id="error-sound" src="assets/sounds/error.mp3"></audio>

  <!-- ✅ Scripts -->
  <script type="module" src="js/user.js"></script>
  <script src="js/spin.js"></script>
  <canvas id="whatsappQR"></canvas>

  <script>
  function openWhatsApp() {
    const uid = document.getElementById("user-uid").textContent.trim();
    const message = `Hi, my UID is ${uid}. Please unlock my FortuneSpin account.`;
    const url = `https://wa.me/6283194274244?text=${encodeURIComponent(message)}`;
    window.open(url, "_blank");
  }

  function copyReferral() {
    const link = document.getElementById("referral-link");
    link.select();
    document.execCommand("copy");
    alert("Link copied!");
  }
</script>
</body>
</html>
