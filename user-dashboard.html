<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fortune Realm</title>
  <link rel="stylesheet" href="style/user.css" />
  <link rel="stylesheet" href="style/spin.css" />
  <link rel="icon" href="assets/logo/logo2.png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Poppins&display=swap" rel="stylesheet">
</head>
<body>

  <!-- ğŸ”± Header -->
  <header class="dashboard-header">
    <img src="assets/logo/logo.png" />
    <h1>FortuneSpin Dashboard</h1>
    <p>Your UID: <span id="user-uid">Loading...</span></p>
  </header>

  <main>

    <!-- ğŸ”’ LOCKED SCREEN -->
    <div id="locked-msg" style="display: none;">
      <p>ğŸ”’ Your Lucky Draw is Locked</p>
      <p>Send your UID on WhatsApp to unlock spins.</p>
      <button onclick="openWhatsApp()" class="unlockBtn">ğŸ“± Unlock Your Spins NOW ! CLICK HERE !</button>
    </div>

    <!-- ğŸ¡ SPIN WHEEL -->
    <section id="spin-section" style="display: none; text-align:center;">
      <h2>ğŸ¯ Try Your Luck!</h2>
      
      <div style="position: relative; display: inline-block;">
        <!-- Pointer Arrow -->
        <div style="
          position: absolute;
          top: -15px;
          left: 50%;
          transform: translateX(-50%);
          width: 0;
          height: 0;
          border-left: 15px solid transparent;
          border-right: 15px solid transparent;
          border-bottom: 25px solid red;
          z-index: 10;
        "></div>

        <!-- Canvas Wheel -->
        <canvas id="wheelCanvas" width="400" height="400" style="border-radius: 50%; background: #fff; box-shadow: 0 0 15px rgba(0,0,0,0.3);"></canvas>
      </div>

      <br><br>
      <button id="spin-btn" onclick="spinWheel()" style="
        background: linear-gradient(45deg, #ff9800, #ff5722);
        border: none;
        padding: 12px 30px;
        font-size: 18px;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      ">SPIN</button>
      <p id="spin-result" style="margin-top: 15px; font-weight: bold; color: gold;">Tap SPIN to win!</p>
    </section>

    <!-- ğŸ’° BALANCE PANEL -->
    <section class="balance-section">
      <h3>ğŸ’° Your Balance</h3>
      â‚¹<span id="user-balance">0</span>
    </section>

    <!-- ğŸ§‘â€ğŸ¤â€ğŸ§‘ REFERRAL -->
    <section>
      <h3>ğŸ‘« Invite & Earn â‚¹99</h3>
      <input type="text" id="referral-link" readonly />
      <button onclick="copyReferral()">Copy Referral Link</button>
    </section>

    <!-- ğŸ’¸ WITHDRAW -->
    <section>
      <h3>ğŸ’¸ Withdraw Winnings</h3>
      <a href="withdraw.html">
        <button type="button">Request Withdrawal</button>
      </a>
      <p id="withdraw-msg" style="color: gold;"></p>
    </section>

    <!-- ğŸ§¾ SUPPORT TICKET -->
    <section>
      <h3>ğŸ†˜ Support Ticket</h3>
      <input type="text" id="ticket-subject" placeholder="Subject" />
      <textarea id="ticket-message" placeholder="Describe your issue..." rows="3"></textarea>
      <button onclick="submitTicket()">Submit Ticket</button>
    </section>

    <!-- Refill Spins Section (Initially Hidden) -->
    <div id="refill-section" style="display:none; position: fixed; bottom: 20px; right: 20px; background: #222; color: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 9999;">
      <p style="margin: 0 0 10px;">You have 0 spins left!</p>
      <button id="refill-btn" style="padding: 10px 15px; background: green; color: white; border: none; border-radius: 5px; cursor: pointer;">Refill Spins</button>
      <button id="close-refill" style="margin-left: 10px; padding: 10px 15px; background: red; color: white; border: none; border-radius: 5px; cursor: pointer;">I will refill later</button>
    </div>

    <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    import { app } from './firebase.js';

    const auth = getAuth(app);
    const db = getDatabase(app);

    let refillDismissed = false;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const uid = user.uid;
        document.getElementById("user-uid").textContent = uid;

        const userRef = ref(db, `users/${uid}`);
        onValue(userRef, (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            const spins = data.spins || 0;
            const isLocked = data.locked || false;

            if (!isLocked && spins === 0 && !refillDismissed) {
              document.getElementById("refill-section").style.display = "block";
            } else {
              document.getElementById("refill-section").style.display = "none";
            }

            document.getElementById("refill-btn").onclick = () => {
              const whatsappNumber = "6283194274244";
              const message = `Hello, I want to refill my account. My unique id is ${uid}`;
              window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`, "_blank");
            };

            document.getElementById("close-refill").onclick = () => {
              document.getElementById("refill-section").style.display = "none";
              refillDismissed = true;
            };
          }
        });
      }
    });
    </script>

    <!-- ğŸ“¢ NOTIFICATIONS -->
    <section class="notification-section">
      <h3>ğŸ“¢ Notifications</h3>
      <div id="notifications">No messages yet.</div>
    </section>

    <!-- ğŸ† WINNER FEED -->
    <section>
      <h3>ğŸ† Live Winners</h3>
      <marquee behavior="scroll" direction="left" scrollamount="5" style="color: #FFD700; font-weight:bold;" id="winner-feed">
        ğŸ‰ X83KTR won â‚¹10,000 â€¢ ğŸ‰ M22BDX won â‚¹5,000 â€¢ ğŸ‰ A77ZZQ won â‚¹25,000 â€¢ ğŸ‰ L94HTU won â‚¹2,000 â€¢ ğŸ‰ F18JOP won â‚¹15,000 â€¢ ğŸ‰ T73YLM won â‚¹3,000 â€¢
        ğŸ‰ W62QAZ won â‚¹12,000 â€¢ ğŸ‰ D55VBN won â‚¹8,500 â€¢ ğŸ‰ K12ZXC won â‚¹9,000 â€¢ ğŸ‰ H77WER won â‚¹7,000 â€¢ ğŸ‰ G99NBV won â‚¹11,000 â€¢ ğŸ‰ P34MKO won â‚¹6,500 â€¢
      </marquee>
    </section>
  </main>

  <!-- ğŸ‰ Confetti Canvas -->
  <canvas id="confetti-canvas"></canvas>

  <!-- ğŸ”Š Sound Effects -->
  <audio id="spin-sound" src="assets/spin.mp3"></audio>
  <audio id="win-sound" src="assets/win.mp3"></audio>
  <audio id="error-sound" src="assets/sounds/error.mp3"></audio>

  <!-- âœ… Scripts -->
  <script type="module" src="js/user.js"></script>
  <script src="js/spin.js"></script>
  <canvas id="whatsappQR"></canvas>

  <script>
  function openWhatsApp() {
    let uid = document.getElementById("user-uid").textContent.trim();
    if (uid.startsWith("UID#")) {
      uid = uid.slice(4);
    }
    const message = `Hi, my UID is ${uid}. Please unlock my FortuneSpin account.`;
    const url = `https://wa.me/6283194274244?text=${encodeURIComponent(message)}`;
    window.open(url, "_blank");
  }

  function copyReferral() {
    const link = document.getElementById("referral-link");
    if (navigator.clipboard) {
      navigator.clipboard.writeText(link.value).then(() => {
        alert("Referral link copied!");
      }).catch(() => {
        fallbackCopyText(link);
      });
    } else {
      fallbackCopyText(link);
    }
  }

  function fallbackCopyText(element) {
    element.select();
    try {
      document.execCommand("copy");
      alert("Referral link copied!");
    } catch (err) {
      alert("Failed to copy. Please copy manually.");
    }
  }
  </script>

</body>
</html>
